- var title = 'Files'

doctype html
html
	head
		include ./head.jade
	body
		div(class='ui container')
			include ./header.jade
			include ./menu.jade
			h2= title
			div(class="ui stackable grid")
				div(class="ten wide column")
					div(class="ui vertical segment")
						h3 Your Files
						select(class="ui position dropdown")
							each position in user.positions
								if (position.folder.id)
									option(value=position.folder.id class="item")= position.title
						script.
							$('.ui.position.dropdown').dropdown();
						div(class="ui vertical segment")
							table(class="ui celled striped files table")
								thead
									tr
										th Name
										th Timestamp
										th Actions
								tbody

						script.
							var parent = 0;
							var current = !{user.positions[0].folder.id};
							function getFiles(dirid) {
								parent = current;
								$('.files.table').addClass("loading");
								$('.files.table tbody').html("");
								$.get('/api/files/'+dirid, function (data) {
									$('.curdir').val(dirid);
									$('.files.table').removeClass("loading");
									current = data.current;
									if (current.parent != 0) {
										$('.files.table tbody').append(
											"<tr><td colspan='3'><a class='directory link' data-id="+current.parent+" href='#'><i class='level up icon'></i>Up a level</a></td></tr>"
										);
									}
									for (i=0; i<data.directories.length; i++) {
										var directory = "<tr>";
										directory += "<td>";
										directory += "<i class='folder icon'></i>";
										directory += "<a class='directory link' data-id='"+data.directories[i].id+"' href='#'>"+data.directories[i].name+"</a>";
										directory += "</td>";
										directory += "<td></td>";
										directory += "<td>";
										directory += "<a href='/admin/files/"+current.id+"/deletefolder/"+data.directories[i].id+"' class='ui negative small button' onclick=\"return confirm('Are you sure you want to delete this folder?');\"><i class='delete icon'></i>Delete</a>";
										directory += "</td>"
										directory += "</tr>";
										$('.files.table tbody').append(directory);
									}
									for (i=0; i<data.files.length; i++) {
										var file = "<tr>";
										file += "<td>";
										file += "<i class='file icon'></i>";
										file +="<a href='/files/uploaded/"+data.files[i].path+"' class='item'>";
										file += data.files[i].name;
										file += "</a></td>";
										file += "<td>";
										file += (new Date(data.files[i].timestamp)).toDateString();
										file += "</td>";
										file += "<td>";
										file += "<a href='/admin/files/"+current.id+"/deletefile/"+data.files[i].id+"' class='ui negative small button' onclick=\"return confirm('Are you sure you want to delete this file?');\"><i class='delete icon'></i>Delete</a>";
										file += "</td>"
										file += "</tr>";
										$('.files.table tbody').append(file);
									}
								});
							}
							$(document).on("click","a.directory.link" ,function (e){
								e.preventDefault();
								getFiles($(this).attr("data-id"));
							});
							$('.ui.position.dropdown').change(function(e) {
								getFiles($(this).children('select').val());
							});
							getFiles(current);

				div(class="six wide column")
					div(class="ui vertical segment")
						h3 Create Folder
						p Create an empty folder in the ucrrent directory.
						form(class="ui form" action="/admin/files/newfolder" method="post")
							div(class="field")
								label Folder Name
								input(type="text" name="name")
							input(type="text" name="folder" class="curdir" hidden)
							button(type="submit" class="ui submit button")
								i(class="folder open icon")
								| Create



					div(class="ui vertical segment")
						h3 Upload a File
						p Upload a file to the current directory.
						form(class="ui form" action="/admin/files/uploadfile" method="post" enctype="multipart/form-data")
							div(class="field")
								label File Name
								input(type="text" name="name")
							div(class="field")
								label File Description
								textarea(rows="1" name="description")
							input(type="text" name="folder" class="curdir" hidden)
							div(Class="field")
								label File to Upload
								input(type="file" name="file")
							button(type="submit" class="ui submit button")
								i(class="upload icon")
								| Upload
